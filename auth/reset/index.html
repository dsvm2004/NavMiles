<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset your password · NavMiles</title>
  <style>
    body { margin:0; padding:0; background:#0b1b2c; font-family: Arial, Helvetica, sans-serif; color:#eef5ff; }
    .wrap { max-width: 520px; margin: 40px auto; padding: 24px; }
    .card { background: #0e2338; border: 1px solid #1c3652; border-radius: 14px; padding: 24px; }
    h2 { margin: 0 0 12px; font-size: 22px; color: #cde5fa; }
    p { margin: 0 0 14px; color:#8ea2be; line-height:1.5; }
    input {
      width:100%; background:#071525; color:#eef5ff; border:1px solid #1c3652; border-radius:10px;
      padding:12px 14px; margin:8px 0; font-size:16px; outline:none;
    }
    button {
      width:100%; padding:12px 16px; border:none; border-radius:10px; font-weight:700; font-size:16px;
      background:#1976d2; color:#fff; cursor:pointer; margin-top:10px;
    }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .msg { margin-top:12px; font-size:14px; color:#78b6ff; }
    .err { color:#ff9aa2; }
    .ok  { color:#79e2a7; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Reset your password</h2>
      <p>If the app didn’t open, you can reset your password here.</p>

      <div id="status" class="msg"></div>

      <form id="form" class="hidden">
        <input id="pw1" type="password" minlength="6" placeholder="New password (min 6 chars)" required />
        <input id="pw2" type="password" minlength="6" placeholder="Confirm new password" required />
        <button id="submitBtn" type="submit">Update Password</button>
      </form>

      <p style="margin-top:12px;">If nothing happened, complete the reset here and then log in to the app.</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === YOUR SUPABASE PROJECT (production) ===
    const SUPABASE_URL = 'https://weqzucvyfjydhgvahuag.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlcXp1Y3Z5Zmp5ZGhndmFodWFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwODk3NjksImV4cCI6MjA2NzY2NTc2OX0.t0nGmoVviaJD6Lbku2XFPshhayjK8zpLRPQtFRMeVUQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const qs = new URL(window.location.href).searchParams;

    // DEBUG overlay (remove after it works)
    document.body.insertAdjacentHTML(
      'afterbegin',
      `<div style="position:fixed;top:8px;left:8px;background:#102842;color:#9fd3ff;padding:8px 10px;border-radius:6px;font:12px/1.3 monospace;z-index:99999;">
         href=${encodeURI(window.location.href)}<br>
         token_hash=${qs.get('token_hash') ? qs.get('token_hash').slice(0,12)+'…' : '(missing)'}<br>
         type=${qs.get('type') || '(missing)'}
       </div>`
    );

    const token_hash = qs.get('token_hash') || '';
    const type       = (qs.get('type') || '').toLowerCase();
    const codeParam  = qs.get('code'); // only for magic link / oauth (not recovery)

    const $status = document.getElementById('status');
    const $form   = document.getElementById('form');
    const $pw1    = document.getElementById('pw1');
    const $pw2    = document.getElementById('pw2');
    const $btn    = document.getElementById('submitBtn');

    function setMsg(text, cls='') {
      $status.className = 'msg ' + (cls || '');
      $status.textContent = text;
    }

    async function init() {
      try {
        // A) Password recovery flow (VERIFY WITH ONLY token_hash + type)
        if (type === 'recovery' && token_hash) {
          setMsg('Verifying your reset link…');
          const { error } = await supabase.auth.verifyOtp({ token_hash, type: 'recovery' });
          if (error) throw error;
          setMsg('Link verified. Enter your new password below.');
          $form.classList.remove('hidden');
          return;
        }

        // B) Magic link / OAuth (not used by the reset email, but safe to support)
        if (codeParam) {
          setMsg('Signing you in…');
          const { error } = await supabase.auth.exchangeCodeForSession(codeParam);
          if (error) throw error;
          setMsg('Signed in. You can now set a new password below.');
          $form.classList.remove('hidden');
          return;
        }

        setMsg('Invalid or expired link. Please request a new password reset.', 'err');
      } catch (e) {
        setMsg(e.message || 'Something went wrong verifying your link.', 'err');
      }
    }

    $form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if ($pw1.value.length < 6) { setMsg('Password must be at least 6 characters.', 'err'); return; }
      if ($pw1.value !== $pw2.value) { setMsg('Passwords do not match.', 'err'); return; }

      try {
        $btn.disabled = true;
        setMsg('Updating password…');
        const { error } = await supabase.auth.updateUser({ password: $pw1.value });
        if (error) throw error;
        setMsg('Password updated! You can close this page and log in to NavMiles.', 'ok');
      } catch (e) {
        setMsg(e.message || 'Could not update password.', 'err');
      } finally {
        $btn.disabled = false;
      }
    });

    init();
  </script>
</body>
</html>
